#!/bin/bash

# Save trace setting
NEC_XTRACE=$(set +o | grep xtrace)
set +o xtrace

source $TOP_DIR/lib/neutron_plugins/ovs_base

function neutron_plugin_create_nova_conf {
    _neutron_ovs_base_configure_nova_vif_driver
}

function neutron_plugin_install_agent_packages {
    _neutron_ovs_base_install_agent_packages
}

function neutron_plugin_configure_common {
    Q_PLUGIN_CONF_PATH=etc/neutron/plugins/nec
    Q_PLUGIN_CONF_FILENAME=necnwa.ini
    Q_PLUGIN_CLASS="necnwa"
    # Temporary use neutron L3RouterPlugin
    Q_SERVICE_PLUGIN_CLASSES="router"
    # Q_SERVICE_PLUGIN_CLASSES="necnwa_router"
    local plugin_conf_src_abspath=${NETWORKING_NEC_DIR}/${Q_PLUGIN_CONF_PATH}
    local plugin_conf_sys_abspath=/${Q_PLUGIN_CONF_PATH}
    cp ${q_plugin_conf_abspath}/${Q_PLUGIN_CONF_FILENAME} ${plugin_conf_sys_abspath}/
    cp ${q_plugin_conf_abspath}/resource_group.json ${plugin_conf_sys_abspath}/
    chmod 0644 /${Q_PLUGIN_CONF_PATH}/${Q_PLUGIN_CONF_FILENAME}
}

function neutron_plugin_configure_debug_command {
    _neutron_ovs_base_configure_debug_command
}

function neutron_plugin_configure_dhcp_agent {
    :
}

function neutron_plugin_configure_l3_agent {
    _neutron_ovs_base_configure_l3_agent
}

function neutron_plugin_configure_plugin_agent {
    # NOTE: If we need to run ovs-agent on compute nodes,
    # it is better to launch nwa-agent separately and
    # use this method to launch ovs-agent. It would be simpler.
    AGENT_BINARY="$NEUTRON_BIN_DIR/neutron-necnwa-agent"
}

function neutron_plugin_configure_service {
    iniset $NEUTRON_CONF DEFAULT api_extensions_path neutron/plugins/nec/extensions/
    iniset /$Q_PLUGIN_CONF_FILE NWA ServerURL $NECNWA_SERVER_URL
    iniset /$Q_PLUGIN_CONF_FILE NWA AccessKeyId $NECNWA_ACCESS_KEY_ID
    iniset /$Q_PLUGIN_CONF_FILE NWA SecretAccessKey $NECNWA_SECRET_ACCESS_KEY
}

function neutron_plugin_setup_interface_driver {
    local conf_file=$1
    iniset $conf_file DEFAULT interface_driver openvswitch
}

# Used by DevStack exercises/neutron-adv-test.sh
function neutron_plugin_check_adv_test_requirements {
    is_service_enabled q-agt && is_service_enabled q-dhcp && return 0
}

# Restore xtrace
$NEC_XTRACE
